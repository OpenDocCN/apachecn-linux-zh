# 一、故障诊断的最佳实践

这一章，也就是第一章，可能是最重要也是最不技术性的一章。 这本书的大多数章节涵盖了特定的问题和必要的命令，以排除这些问题。 然而，本章将涵盖一些可应用于任何问题的故障排除最佳实践。

您可以将本章视为应用实践背后的原则。

# 故障排除方式

在介绍故障排除的最佳实践之前，了解不同类型的故障排除是很重要的。 在我的经验中，我发现人们倾向于使用以下三种类型的故障排除之一:

*   数据收集器
*   受过教育的猜测者
*   适配器

每一种风格都有自己的优点和缺点。 让我们来看看这些风格的特点。

## 数据收集器

我喜欢将第一种类型的故障排除称为**数据收集器**。 数据收集器通常使用系统方法来解决问题。 系统故障排除方法的一般特点如下:

*   向报告方提出具体问题，期望得到详细回答
*   运行命令来识别大多数问题的系统性能
*   在开始操作之前，运行一组预定义的故障排除步骤

这种风格的优点在于它是有效的，不管是什么级别的工程师或管理员在使用它。 通过系统地检查问题，收集每个数据点，并在执行任何解决方案之前了解结果，数据收集器能够解决他们不一定熟悉的问题。

这种风格的缺点是，数据收集通常不是解决问题的最快方法。 根据问题的不同，收集数据可能需要很长时间，其中一些数据可能不是找到解决方案所必需的。

## 有学识的猜测者

我喜欢将称为第二种类型的故障排除，即**有教养的猜测者**。 有教养的猜测者是那些通常使用直觉的方法来解决问题的人。 直观的方法通常有以下特点:

*   用最少的信息确定问题的原因
*   在解决问题之前运行几个命令
*   利用以前的经验找出根本原因

这种类型的故障排除的优点是它允许您更快地提出解决方案。 当遇到问题时，这种类型的疑难解答人员倾向于借鉴经验，并且只需要很少的信息就能找到解决方案。

这种风格的缺点在于它严重依赖于经验，因此在有效之前需要时间。 当关注解决方案时，该故障诊断人员可能还会尝试多个操作来解决问题，这可能会使受过良好教育的猜测者看起来并没有完全理解当前的问题。

## 适配器

第三种是，也是经常被忽视的故障诊断风格; 这种风格既运用了系统风格，也运用了直观风格。 我喜欢将这种类型称为**适配器**。 适配器具有独特的特性，使其能够在系统的和直观的故障诊断风格之间切换。 这种组合风格通常比数据收集器风格更快，而且比有教养的猜测者风格更注重细节。 这是因为他们能够应用适合手头任务的故障排除风格。

## 选择合适的风格

虽然很容易说一种方法比另一种更好，但事实是，选择适当的故障排除风格在很大程度上取决于个人。 了解哪种故障排除风格最适合您的个性是很重要的。 通过了解哪种风格更适合你，你可以学习和使用适合这种风格的技术。 您还可以从其他风格中学习和采用技术来应用您通常会忽略的故障排除步骤。

本书将展示数据收集者和有教养的猜测者两种类型的故障诊断，并定期强调哪一种个性风格的步骤最适合。

# 故障处理步骤

故障排除是一个既严格又灵活的过程。 故障排除过程的刚性是基于以下事实:需要遵循一些基本步骤。 这样，我喜欢将故障排除过程等同于科学方法，其中科学方法具有必须遵循的特定步骤列表。

故障排除流程的灵活性在于，可以按照任何合理的顺序执行这些步骤。 与科学方法不同，故障排除过程的目标通常是快速解决问题。 有时，为了快速解决问题，您可能需要跳过一个步骤或按顺序执行它们。 例如，使用故障排除流程，您可能需要解决当前问题，然后确定该问题的根本原因。

下面的列表包含五个组成故障排除流程的步骤。 每个步骤还可以包括几个子任务，这些子任务可能与问题相关，也可能与问题无关。 遵循这些步骤是很重要的，因为不是每个问题都可以放在同一个桶里。 下面的步骤是用来作为一种最佳做法，但是，和所有事情一样，它应该适应当前的问题:

1.  理解问题陈述。
2.  建立一个假设。
3.  试验和错误。
4.  得到帮助。
5.  文档。

## 理解问题陈述

用科学方法，第一步是建立问题陈述，也就是说:确定并理解实验的目的。 对于故障排除流程，第一步是理解报告的问题。 我们对问题理解得越好，解决问题就越容易。

我们可以执行许多任务来帮助我们更好地理解问题。 这是第一步，数据收集者的个性脱颖而出。 从本质上来说，数据收集者会在进入下一个步骤之前收集尽可能多的数据，然而，有经验的猜测者通常倾向于快速完成这个步骤，然后进入下一个步骤，这有时会导致一些关键信息被遗漏。

适配器倾向于理解哪些数据收集步骤是必要的，哪些不是。 这使得他们可以像数据收集器一样收集数据，但不需要花费时间来收集不会为当前问题增加价值的数据。

此故障排除步骤中的子任务是*提出正确的问题*。

### 问问题

无论是通过人工还是通过诸如票务系统这样的自动化流程，问题的报告者往往是信息的重要来源。

#### 门票

当他们收到一张票时，有教养的猜测者通常会读到票的标题，对问题做出假设，然后进入理解问题的下一个阶段。 数据收集者通常会打开票据并阅读票据的全部细节。

虽然这取决于票务和监控系统，但一般来说，票务中可能有有用的信息。 除非这个问题是一个常见的问题，并且您能够理解您从报头所知道的所有内容，否则阅读票证描述通常是一个好主意。 即使是少量的信息也可能有助于解决特别棘手的问题。

#### 人类

然而，从人类收集额外的信息可能是不一致的。 这在很大程度上取决于所支持的环境。 在某些环境中，报告问题的人员可以提供解决问题所需的所有细节。 在其他环境中，他们可能不理解问题，而只是简单地解释症状。

无论哪种解决问题的方式最适合你的个性，能够从报告问题的人那里获得重要的信息是一项重要的技能。 直觉型的问题解决者，如有教养的猜测者或适配器，往往发现这个过程比数据收集者更容易，不是因为这些人一定更擅长从人们那里获取细节，而是因为他们能够识别出具有较少信息的模式。 然而，如果数据收集器准备询问故障排除问题，那么他们可以从报告问题的获得他们需要的信息。

### 注意事项

Don't be afraid to ask the obvious questions .不要害怕问明显的问题。

我的第一份技术工作是在一个网络托管技术支持呼叫中心。 在那里，我经常接到用户的电话，他们不想执行基本的故障排除步骤，只是希望问题升级。 这些用户只是觉得他们自己已经执行了所有的故障排除步骤，并且发现了一个超出了一级支持的问题。

虽然有时这是真的，但更多的时候，问题是他们忽略了的一些基本问题。 在这个角色中，我很快了解到，即使用户不愿意回答基本或明显的问题，到最后，他们只是希望自己的问题得到解决。 如果这意味着要经历重复的步骤，那也没关系，只要问题得到解决。

即使在今天，由于我现在是高级工程师的升级点，我发现很多时候工程师(即使他们有多年的故障排除经验)忽略了简单的基本步骤。

问一些看似基本的简单问题有时能节省很多时间; 所以不要害怕问他们。

### 试图复制问题

收集信息和理解问题的最佳方法之一是亲身体验。 当报告一个问题时，最好复制该问题。

虽然用户可以是大量信息的来源，但他们并不总是最可靠的; 通常情况下，用户可能会遇到错误，但忽略了它，或者只是在报告问题时忘记传递错误。

通常，我要问用户的第一个问题是如何重新创建问题。 如果用户能够提供此信息，我将能够看到任何错误，并且通常能够更快地确定问题的解决方案。

### 注意事项

**有时重复问题是不可能的**

虽然复制问题总是最好的，但并不总是可能的。 每天，我和许多团队一起工作; 有时，这些团队在公司内部，但很多时候他们是外部供应商。 在一个关键的问题中，我经常会看到有人做出笼统的声明，比如“如果我们不能复制它，我们就不能排除它”。

虽然重复一个问题有时是找到根本原因的唯一途径，这是真的，但我经常听到这种说法被滥用。 复制一个问题应该被视为一种工具; 它只是众多工具中的一个在您的故障排除工具带。 如果没有可用的工具，那么您只能使用另一种工具。

无法找到解决方案与由于无法复制一个问题而不试图找到解决方案之间存在显著差异。 后者不仅没有帮助，而且不专业。

### 运行调查类命令

最有可能的是，您阅读这本书是为了学习排除 Red Hat Enterprise Linux 系统故障的技术和命令。 理解问题陈述的第三个子任务就是运行调查命令来确定问题的原因。 但是，在执行调查命令之前，一定要知道前面的步骤是按逻辑顺序进行的。

最好的做法是，首先向报告问题的用户询问问题的一些基本细节，然后在获得足够的信息后，复制问题。 重复问题之后，下一个逻辑步骤是运行必要的命令来排除问题并调查问题的原因。

在故障排除过程中，您经常会回到前面的步骤。 在识别出一些关键错误后，您可能会发现必须向原始记者询问其他信息。 在进行故障排除时，不要害怕后退几步，以便清楚地了解手头的问题。

## 建立假设

用科学的方法，一旦问题陈述被制定出来，就该是建立假说的时候了。 通过故障排除过程，在您确定了问题、收集了关于问题的信息(如错误、系统当前状态等等)之后，还需要确定您认为是什么导致了问题或正在导致问题。

然而，有些问题可能不需要太多的假设。 通常，日志文件中的错误或系统当前状态可能会解释问题发生的原因。 在这种情况下，您可以简单地解决问题，然后进入*Documentation*步骤。

对于不固定的问题，您需要对根本原因进行假设。 这是必要的，因为形成假设后的下一步是试图解决问题。 如果你至少没有一个根本原因的理论，就很难解决一个问题。

这里有一些技巧可以用来帮助形成一个假设。

### 组合模式

当在前面的步骤中执行数据收集时，您可能会开始看到模式。 模式可以是简单的跨多个服务的类似日志条目、发生的故障类型(例如，多个服务下线)，甚至是系统资源利用中出现的峰值。

这些模式可以用来形成问题的理论。 为了让大家明白这一点，让我们来看看一个真实的场景。

您正在管理一个既运行 web 应用又接收电子邮件的服务器。 您有一个监视系统，它检测到 web 服务的错误并创建了一个票据。 在调查罚单时，您还会收到一个来自电子邮件用户的电话，说明他们正在收到电子邮件反弹。

当您要求用户为您读出错误时，他们会提到`No space left on device`。

让我们来分析一下这个场景:

*   来自监视解决方案的通知告诉我们 Apache 宕机了
*   我们还收到了来自电子邮件用户的报告，其中的错误表明文件系统已满

这一切是否意味着 Apache 由于文件系统已满而关闭? 可能。 我们应该调查它吗? 绝对的!

### 这是我以前遇到过的吗?

上述分解导致了形成假设的下一个技术。 这听起来很简单，但却经常被遗忘。 “我以前见过这样的东西吗?”

在前面的场景中，从电子邮件反弹中报告的错误通常表明文件系统已满。 我们是怎么知道的? 很简单，我们以前见过。 也许我们在电子邮件反弹中看到了同样的错误，或者我们在其他服务中看到了同样的错误。 重点是，误差是常见的，误差通常意味着一件事。

记住常见的错误对于像有教养的猜测者和适配器这样的直观类型来说是非常有用的; 这是他们倾向于自然表现的东西。 对于数据收集器，一个方便的技巧是随手保留一个常见错误的引用表。

### 提示

从我的经验来看，大多数数据收集者倾向于保存一组记录，其中包含过程的通用命令或步骤等内容。 添加常见的错误以及这些错误背后的含义是数据收集者等系统思考者更快地建立假设的好方法。

总之，建立一个假设对于所有类型的疑难解答者都是很重要的。 这是直觉思考者(如受过教育的猜测者和适配器者)擅长的领域。 一般来说，这些类型的疑难解答者会更快地形成一个假设，即使有时这些假设并不总是正确的。

## 试错

在科学的方法中，假设一旦形成，下一步就是实验。 对于故障排除，这等同于尝试解决问题。

有些问题很简单，可以根据经验使用标准程序或步骤来解决。 然而，其他问题就没那么简单了。 有时，假设被证明是错误的，或者问题最终比最初想象的更复杂。

在这种情况下，可能需要多次尝试才能解决问题。 我个人认为这类似于试错。 一般来说，您可能知道什么是错误的(假设)，并知道如何解决它。 您尝试解决它(尝试)，如果不起作用(错误)，您就转向下一个可能的解决方案。

### 从创建备份开始

服用了一个新的角色作为 Linux 系统管理员,如果只有一条建议我可以给,那将是一个大多数人都已经吸取了教训:*进行更改之前,备份所有的*。

许多时候，作为系统管理员，我们发现自己需要更改配置文件或删除一些不需要的文件来解决问题。 不幸的是，我们可能认为我们知道什么需要删除或改变，但并不总是正确的。

如果进行了备份，则只需将更改恢复到以前的状态，而不需要备份。 因此，恢复更改并不容易。

备份可以包含许多内容，它可以是使用`rdiff-backup`之类的内容的完整系统备份、VM 快照，或者简单到创建一个文件副本。

### 提示

对于那些有兴趣了解本技巧的实际应用范围的人，只需在任何拥有四个以上系统管理员的服务器上运行以下命令，并且已经运行了好几年:

```sh
$ find /etc –name "*.bak"

```

## 寻求帮助

在许多情况下，在这一点上问题就解决了，但与故障排除流程中的每个步骤非常相似，它取决于手头的问题。 虽然获得帮助并不完全是一个故障排除步骤，但如果您不能自己解决问题，那么得到帮助通常是下一个合乎逻辑的步骤。

在寻求帮助时，通常有六种可用的资源:

*   书
*   团队维基或运行手册
*   谷歌
*   手册页
*   redhat 内核文档
*   人

### 书籍

对于特定类型的问题，参考命令或故障排除步骤是很好的。 其他书籍，比如专门研究特定技术的书籍，可以很好地参考该技术是如何工作的。 在过去的几年里，经常可以看到一个高级管理人员有一个书架，上面放满了技术书籍。

在当今世界，由于书籍更频繁地以数字格式出现，它们甚至更容易用作参考。 数字格式使它们易于搜索，并允许读者比传统印刷版本更快地找到特定的部分。

### 团队 wiki 或 Runbooks

在**Team Wikis**变得普遍之前，许多操作组有实体书，称为**Runbooks**。 这些书是操作团队为了保持生产环境正常运行而每天使用的流程和过程的列表。 有时，这些运行手册将包含用于供应新服务器的信息，有时它们将专门用于故障排除。

在今天的世界中，这些 Runbooks 已经被 Team wiki 所取代，这些 wiki 通常具有相同的内容，但是是在线的。 它们也易于搜索和更新，这意味着它们通常比传统的印刷 Runbook 更相关。

团队 wiki 和 Runbooks 的好处在于不仅可以解决特定于您的环境的问题，而且还可以解决这些问题。 配置服务(如 Apache)的方法有很多，外部系统创建对这些服务的依赖关系的方法甚至更多。

在某些环境中，您可能能够在出现问题时简单地重新启动 Apache，但在其他环境中，您可能实际上必须执行几个先决条件步骤。 如果在重新启动服务之前需要遵循特定的流程，最佳实践是在 Team Wiki 或 Runbook 中记录该流程。

### 谷歌

谷歌是这样的系统管理员的通用工具，在某一时刻，在`google.com/linux`、`google.com/microsoft`、`google.com/mac`和`google.com/bsd`有特定的搜索门户可用。

谷歌贬低了这些搜索门户，但这并不意味着系统管理员使用谷歌或任何其他搜索引擎进行故障排除的次数减少了。

事实上，在当今世界，在技术面试中经常听到“我会谷歌 it”这样的话。

对于那些在系统管理任务中使用谷歌的新手，有一些提示:

*   If you copy and paste a full error message (removing the server specific text) you will likely find more relevant results:

    例如，搜索*kdumpctl:没有为崩溃内核*保留的内存将返回 600 个结果，而搜索*为崩溃内核*保留的内存将返回 449,000 个结果。

*   通过搜索`man`和`man netstat`这样的命令，您可以找到任何手册页的在线版本。
*   您可以将错误封装在双引号中，以细化包含相同错误的搜索结果。
*   以问题的形式问你想要什么通常会在教程中得到结果。 例如，*如何在 RHEL 7 上重启 Apache ?*

虽然谷歌可以是一个伟大的资源，结果应该总是带着一粒盐。 通常，在谷歌上搜索错误时，您可能会发现一个建议命令，它提供的解释很少，只是简单地说“运行这个，它将修复它”。 在运行这些命令时要非常小心，您在系统上执行的任何命令都应该是您熟悉的命令，这一点很重要。 在执行之前，您应该始终知道命令是做什么的。

### Man 页面

当谷歌不可用或甚至有时可用时，关于命令或 Linux 的最佳信息来源通常是**手册页**。 手册页是核心 Linux 手册文档，可以通过`man`命令访问。

例如，要查找`netstat`命令的文档，只需运行以下命令:

```sh
$ man netstat
NETSTAT(8)
Linux System Administrator's Manual
NETSTAT(8)

NAME
       netstat - Print network connections, routing tables, interface statistics, masquerade connections, and multicast memberships
```

正如您所看到的，该命令不仅输出了关于`netstat`命令的信息，而且还包含了使用信息的快速概要，如以下所示:

```sh
SYNOPSIS
      netstat  [address_family_options]  [--tcp|-t]  [--udp|-u] [--udplite|-U] [--raw|-w] [--listening|-l] [--all|-a] [--numeric|-n] [--numeric-hosts]
       [--numeric-ports] [--numeric-users] [--symbolic|-N] [--extend|-e[--extend|-e]]  [--timers|-o]  [--program|-p] [--verbose|-v]  [--continuous|-c]
       [--wide|-W] [delay]
```

此外，它还详细描述了每个旗帜及其功能:

```sh
   --route , -r
       Display the kernel routing tables. See the description in route(8) for details.  netstat -r and route -e produce the same output.

   --groups , -g
       Display multicast group membership information for IPv4 and IPv6.

   --interfaces=iface , -I=iface , -i
       Display a table of all network interfaces, or the specified iface.
```

一般来说，核心系统和库的基本手册页面是随`man-pages`包分发的。 特定命令(如`top`、`netstat`或`ps`的手册页作为该命令安装包的一部分分发。 这是因为单独的命令和组件的文档留给了包维护人员。

这可能意味着一些命令的文档级别没有其他命令的文档级别。 但是，一般来说，手册页是非常有用的信息源，可以回答大多数日常问题。

#### 阅读手册页

在前面的示例中，我们可以看到`netstat`的手册页包含一些信息部分。 一般来说，帮助手册页具有一致的布局，其中一些常见的部分可以在大多数帮助手册页中找到。 以下是一些常见部分的简单列表:

*   的名字
*   剧情简介
*   描述
*   例子

##### 名称

**名称**部分通常包含命令的名称和非常简短的命令描述。 下面是来自`ps`命令的手册页的名称部分:

```sh
NAME
       ps - report a snapshot of the current processes.
```

##### 大纲

命令的手册页的**摘要**部分通常会列出命令，后面跟着可能的命令标志或选项。 这个部分的一个很好的例子可以在`netstat`命令的概要中看到:

```sh
SYNOPSIS
       netstat  [address_family_options]  [--tcp|-t]  [--udp|-u] [--raw|-w]  [--listening|-l]  [--all|-a] [--numeric|-n] [--numeric-hosts] [--numeric-ports]
       [--numeric-users] [--symbolic|-N] [--extend|-e[--extend|- e]] [--timers|-o] [--program|-p] [--verbose|-v] [--continuous|-c]
```

作为命令语法的快速参考，本节非常有用。

##### 描述

**描述**部分通常包含更长的命令描述，以及各种命令选项的列表和解释。 下面的代码片段来自`cat`命令的手册页:

```sh
DESCRIPTION
       Concatenate FILE(s), or standard input, to standard output.

       -A, --show-all
              equivalent to -vET

       -b, --number-nonblank
              number nonempty output lines, overrides -n
```

描述部分非常有用，因为它不仅仅是查找选项。 在本节中，您通常可以找到有关命令的细微差别的文档。

##### 例子

手册页通常也会包括使用该命令的示例:

```sh
EXAMPLES
       cat f - g
             Output f's contents, then standard input, then g's infocontents.
```

前面是来自`cat`命令的手册页的一个片段。 在这个例子中，我们可以看到如何使用`cat`在一个命令中读取文件和标准输入。

在本节中，我经常可以找到使用以前多次使用过的命令的新方法。

##### 附加部分

除了前面的部分，您可能还会看到**参见 also**、**Files**、**Author**和**History**。 这些部分也可以包含有用的信息; 然而，并不是每个 man page 都有它们。

#### 信息文档

除了手册页之外，Linux 系统通常还包含**信息文档**，这些文档的设计目的是在手册页中包含更多的额外文档。 与 man 页面非常相似，信息文档包含在命令包中，文档的质量/数量因包而异。

调用信息文档的方法类似于手册页，只需执行`info`命令，然后执行您希望查看的主题:

```sh
$ info gzip
GNU Gzip: General file (de)compression
**************************************

This manual is for GNU Gzip (version 1.5, 10 June 2014), and documents commands for compressing and decompressing data.

   Copyright (C) 1998-1999, 2001-2002, 2006-2007, 2009-2012 Free
Software Foundation, Inc.
```

#### 引用多个命令

除了使用 man 页面和信息文档来查找命令; 这些工具还可以用于查看其他项目(如系统调用或配置文件)的文档。

例如，如果您要使用`man`来搜索术语`signal`，您将看到以下内容:

```sh
$ man signal
SIGNAL(2)
Linux Programmer's Manual
SIGNAL(2)

NAME
 signal - ANSI C signal handling

SYNOPSIS
 #include <signal.h>

 typedef void (*sighandler_t)(int);

 sighandler_t signal(int signum, sighandler_t handler);

DESCRIPTION
 The  behavior of signal() varies across UNIX versions, and has also varied historically across different versions of Linux. Avoid its use: use sigaction(2) instead.  See Portability below.

signal() sets the disposition of the signal signum to handler, which is either SIG_IGN, SIG_DFL, or the address of a programmer-defined  function  (a "signal handler").

```

`Signal`是一个非常重要的系统调用，也是 Linux 的核心概念。 知道可以使用`man`和`info`命令来查找核心 Linux 概念和行为，这在故障诊断期间非常有用。

#### 安装手册

Red Hat EnterpriseLinux 发行版通常包括`man-pages`包; 如果您的系统没有安装`man-pages`包，您可以使用`yum`命令安装它:

```sh
# yum install man-pages

```

### Red Hat 内核文档

除了手册页之外，Red Hat 发行版还有一个名为**kernel-doc**的包。 这个包包含了相当多的关于系统内部如何工作的信息。

内核文档是一组放在`/usr/share/doc/kernel-doc-<kernel-version>/`中的文本文件，并根据它们所涉及的主题进行分类。 这个资源对于更深入的故障诊断非常有用，比如调整内核可调项或理解`ext4`文件系统如何利用日志。

默认情况下，没有安装`kernel-doc`包，但是，可以使用`yum`命令轻松地安装它:

```sh
# yum install kernel-doc

```

### 人

无论是朋友还是团队领导，在向他人寻求帮助时都有一定的礼仪。 以下是人们在被要求帮助解决问题时通常会想到的一些事情。 有人向我求助时，我希望你能:

*   **尝试解决它自己**:升级一个问题的时候,最好至少试着按照*理解问题*语句和形成假说*故障诊断过程的步骤。*
**   **记录您的尝试**:文档是升级问题或获得帮助的关键。 您越好地记录尝试的步骤和发现的错误，其他人就会越快地识别和解决问题。*   :当你将问题升级时，首先要指出的一件事就是你的假设。 通常情况下，这可以帮助加快解决方案，引导下一个人找到可能的解决方案，而无需执行数据收集活动。*   **提到这个系统最近是否发生了其他任何事情**:问题通常是成对出现的，突出显示系统或受影响系统上正在发生的所有因素是很重要的。*

 *前面的列表虽然不是很广泛，但很重要，因为每个关键信息都可以帮助下一个人有效地排除问题。

#### 跟进

当逐步升级问题时，最好的做法是跟踪对方，看看他们做了什么，以及他们是如何做到的。 这一点很重要，因为这会让对方知道你愿意了解更多，很多时候这会让他们花时间解释他们是如何解决和确定问题的。

这样的交互将为您提供更多的知识，并帮助您构建系统的管理技能和经验。

## 文档

文档是故障排除过程中的关键步骤。 在流程的每一步中，关键是要记录并记录正在执行的操作。 为什么写文档很重要? 三个主要原因:

*   当问题升级时，你记下的信息越多，你就越有可能传递给别人
*   如果问题是反复出现的问题，那么可以使用文档更新 Team Wiki 或 Runbook
*   如果在您的环境中执行**根本原因分析**(**RCA**)，那么 RCA 将需要所有这些信息

根据环境的不同，文档可以是保存在本地系统文本文件中的简单注释，也可以是票据系统所需的注释。 每个工作环境都是不同的，但总的规则是*没有太多的文档*。

对于数据收集器来说，这一步是相当自然的。 因为大多数数据收集者通常会保留一些笔记供自己使用。 对于有经验的猜测者来说，这一步似乎是不必要的。 然而，对于任何反复出现或需要升级的问题，文档是至关重要的。

什么样的信息应该被记录? 下面的列表是一个很好的起点，但与故障排除中的大多数事情一样，它取决于环境和问题:

*   问题陈述，正如你所理解的
*   是什么导致了问题的假设
*   在信息收集步骤中收集的数据:
    *   具体的错误发现
    *   相关的系统指标(例如，CPU、内存和磁盘利用率)
*   在信息收集步骤中执行的命令(在合理的情况下，不需要包含执行的每个`cd`或`ls`命令)
*   在尝试解决问题期间所采取的步骤，包括执行的特定命令

有了前面的项的良好文档记录，如果再次出现问题，那么获取文档并将其移动到 Team Wiki 中就相对简单了。 这样做的好处是，需要在重复出现时解决相同问题的其他团队成员可以使用 Wiki 文章。

前面列出的文档的三个原因之一是在根本原因分析期间使用文档，这就引出了我们的下一个主题——建立根本原因分析。

# 根本原因分析

根本原因分析是在事件发生后进行的过程。 RCA 过程的目标是确定事件的根本原因，并确定任何可能的纠正措施，以防止同样的事件再次发生。 这些纠正措施可能和建立用户培训一样简单，以便跨所有 web 服务器重新配置 Apache。

RCA 过程并非技术所独有，它在航空和职业安全等领域广泛应用。 在这些领域中，事故通常不仅仅是几台计算机脱机。 这些事件可能会危及一个人的生命。

## 一个好的 RCA 的解剖

不同的工作环境可能会以不同的方式实现 RCA 过程，但在一天结束的时候，每一个好的 RCA 都有几个关键元素:

*   正如报道的那样
*   问题的真正根源
*   事件和行动的时间表
*   任何关键数据点
*   防止事故再次发生的行动计划

### 正如报道的那样

故障排除过程中的第一个步骤是识别问题; 该信息是 rca 的关键信息。 根据问题的不同，重要性也会有所不同。 有时，这些信息将显示问题是否被正确识别。 大多数时候，它可以用来估计问题的影响。

理解一个问题的影响是非常重要的，对一些公司和问题来说，这可能意味着损失收入; 对于其他公司来说，这可能意味着他们的品牌受损，或者根据问题的不同，这可能根本没有任何意义。

### 问题的真正根源

根本原因分析的这个元素的重要性不言自明。 然而，有时可能无法确定根本原因。 在本章和[第 12 章](12.html#29DRA1-8ae10833f0c4428b9e1482c7fee089b4 "Chapter 12. Root Cause Analysis of an Unexpected Reboot")、*意外重启的根本原因分析*中，我将讨论无法找到完全根本原因的问题。

## 事件和所采取的行动的时间表

如果我们以航空事故为例，很容易看到事件的时间线，如飞机何时起飞，乘客何时登机，以及维修人员何时完成评估，可以是有用的。 技术事件的时间线也非常有用，因为它可以用来确定影响的长度以及采取关键行动的时间。

一个好的时间表应该包括时间和事件的主要事件。 以下是一个技术事件的时间轴示例:

*   8 点，Joe b 打电话给 NOC 热线，报告坦佩的电子邮件服务器出现故障
*   在 8 点 15 分，John c 登陆了 Tempe 的电子邮件服务器，并注意到它们的可用内存即将耗尽
*   8 点 17 分，根据 Runbook, John c 开始逐个重启电子邮件服务器

### 任何验证根本原因的关键数据点

除了事件的时间轴外，RCA 还应该包括关键数据点。 再次以航空为例，一个关键的数据点将是事故期间的天气状况、相关人员的工作时间或飞机的状况。

我们的时间轴示例包括一些关键数据点，包括:

*   事件发生时间:08:00
*   电子邮件服务器状态:可用内存不足
*   受影响的服务:电子邮件

无论这些数据点是独立的还是在一个时间轴内，确保这些数据点在 RCA 中被很好地记录是很重要的。

## 防止事故再次发生的行动计划

执行根本原因分析的全部要点是确定事件发生的原因和防止其再次发生的行动计划。

不幸的是，这是我看到许多 RCA 忽略的领域。 如果实施得好，RCA 过程是有用的; 然而，如果执行不当，它们可能会变成时间和资源的浪费。

通常情况下，由于实现很差，您会发现无论大小，每个事件都需要 rca。 这样做的问题是，它会导致 rca 的质量下降。 RCA 应该只在事件造成重大影响时执行。 例如，硬件故障是不可预防的，您可以使用硬盘驱动器的`smartd`等工具主动识别硬件故障，但除了替换它们之外，您不能总是防止它们故障。 对于每一个硬件故障和更换都需要一个 RCA，这是 RCA 过程实现不佳的一个例子。

当工程师需要确定硬件故障等常见问题的根本原因时，他们会忽略根本原因过程。 当工程师对一种类型的事故忽略 RCA 过程时，它可能会蔓延到其他类型的事故，从而影响 RCA 的质量。

RCA 应该只保留给具有重大影响的事件。 次要事件或常规事件不应该有 RCA 要求; 然而，他们应该被跟踪。 通过跟踪已经更换的硬盘驱动器的数量以及这些硬盘驱动器的制造和型号，可以识别硬件质量问题。 重置用户密码等例行事件也是如此。 通过跟踪这些类型的事件，有可能确定可能的改进领域。

## 确定根本原因

为了更好地理解 RCA 过程，让我们使用一个在生产环境中看到的假想问题。

### 注意事项

web 应用在写入文件时崩溃

登录到系统后，您会发现应用崩溃了，因为应用试图写入的文件系统已满。

### 注意事项

**根本原因并不总是显而易见的原因**

问题的根本原因是文件系统已满吗? 不。 虽然文件系统满可能导致应用崩溃，但这就是所谓的影响因素。 可以纠正一个影响因素，例如文件系统已满，但这不能防止问题再次发生。

此时，重要的是要确定为什么文件系统是满的。 在进一步的调查中，您发现这是由于同事禁用了删除旧应用文件的**cron 作业**。 在禁用 cron 作业之后，文件系统上的可用空间逐渐减少。 最终，文件系统得到了 100%的利用。

在本例中，问题的根本原因是禁用的 cron 作业。

### 有时你必须牺牲根本原因分析

让我们看看另一种假设的情况，其中一个问题导致了中断。 由于这个问题造成了重大影响，它绝对需要一个 RCA。 问题是，为了解决这个问题，您需要执行一个消除执行精确 RCA 可能性的活动。

这些情况有时需要进行判断，是让停机时间长一点，还是解决停机并牺牲 RCA 的任何机会。 不幸的是，对于这些情况没有单一的答案，正确的答案取决于问题和所影响的环境。

### 提示

在研究金融系统时，我发现自己不得不经常做出这样的决定。 对于任务关键型系统，答案几乎总是在执行根本原因分析之前恢复服务。 然而，只要有可能，总是首选首先捕获数据，即使数据不能立即审查。

# 了解你的环境

本章的最后一节是我能建议的最重要的最佳实践之一。 最后一部分介绍了了解环境的重要性。

有些人认为，系统管理员的工作仅止于系统上安装的应用，系统管理员应该只关心操作系统和操作系统的组件，如网络或文件系统。

我不赞同这种哲学。 实际上，系统管理员往往比创建应用的开发团队更了解应用在生产环境中的工作方式。

根据我的经验，为了真正支持服务器，您必须了解在该服务器中运行的服务和应用。 例如，在许多企业环境中，系统管理员被期望处理 web 服务器的配置和管理(例如，Apache 和 Nginx)。 但是，不期望同一个系统管理员管理 Apache 背后的应用(例如 Java 和 C)。

Apache 与 Java 应用的区别是什么? 答案是什么都没有; 在一天结束时，它们都是运行在服务器上的应用。 我看到过许多管理员在遇到与应用相关的问题时，只是袖手旁观。 然而，如果问题与 Apache 有关，他们就会立即采取行动。

最后，如果这些行政部门与发展部门合作，这些问题可能会得到更快的解决。 理解并帮助解决系统上加载的任何软件的问题是管理员的责任。 该软件是随操作系统一起发布的，还是稍后由应用团队安装的。

# 总结

在本章中，您了解了有两种主要的故障排除风格，直观的(有经验的猜测者)和系统的(数据收集者)。 我们讨论了哪些故障排除步骤最适合这两种类型，以及一些(适配器)可以利用这两种类型的故障排除。

在本书接下来的章节中，当我们对现实生活中的场景进行故障诊断时，我将使用本章中所讨论的过程中强调的直观和系统的故障诊断步骤。

本章没有涉及技术细节; 下一章将充满技术细节，因为我们将介绍和探索用于故障排除的常见 Linux 命令。*