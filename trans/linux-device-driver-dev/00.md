# 前言

Linux 内核是一个复杂的、可移植的、模块化的、广泛使用的软件，运行在全球超过一半的设备中约 80%的服务器和嵌入式系统上。设备驱动程序在一个 Linux 系统表现如何的背景下起着关键的作用。由于 Linux 已经成为最受欢迎的操作系统之一，开发个人设备驱动程序的兴趣也在稳步增长。

设备驱动程序是通过内核连接用户空间和设备的纽带。

这本书将以两章开始，这两章将帮助您理解驱动程序的基础知识，并为您通过 Linux 内核的漫长旅程做好准备。然后，本书将涵盖基于 Linux 子系统的驱动程序开发，如内存管理、脉宽调制、实时时钟、IIO、通用输入输出、内部时钟管理。这本书还将涵盖直接内存访问和网络设备驱动程序的实用方法。

本书的源代码已经在 x86 PC 和 SECO 的 UDOO Quad 上进行了测试，后者基于恩智浦的 ARM i.MX6，具有足够的特性和连接，可以覆盖本书讨论的所有测试。还提供了一些驱动程序，用于测试廉价组件，如 MCP23016 和 24LC512，它们分别是 I2C GPIO 控制器和 eeprom 存储器。

到本书结束时，您将对设备驱动程序开发的概念感到满意，并且能够使用最新的内核版本(编写时为 v4.13)从头开始编写任何设备驱动程序。

# 这本书涵盖了什么

*[第 1 章](01.html#LTSU0-dbde2ca892a6480b9727afb6a9c9e924)【内核开发入门】*介绍 Linux 内核开发流程。本章将讨论内核的下载、配置和编译步骤，以及 x86 和基于 ARM 的系统

*[第二章](02.html#10DJ40-dbde2ca892a6480b9727afb6a9c9e924)【设备驱动基础】*通过内核模块来处理 Linux 模块化，并描述了它们的加载/卸载。它还描述了驱动程序体系结构和一些基本概念以及一些内核最佳实践。

*[第 3 章](03.html#1S2JE0-dbde2ca892a6480b9727afb6a9c9e924)【内核设施和助手函数】*介绍了常用的内核函数和机制，例如工作队列、等待队列、互斥体、自旋锁以及任何其他有助于提高驱动程序可靠性的设施。

*[第 4 章](04.html#3JCK20-dbde2ca892a6480b9727afb6a9c9e924)，角色设备驱动程序*，重点介绍通过角色设备将设备功能导出到用户空间，以及使用 IOCTL 接口支持自定义命令。

*[第五章](05.html#4B7I40-dbde2ca892a6480b9727afb6a9c9e924)，平台设备驱动*，解释了什么是平台设备，介绍了伪平台总线的概念，以及设备和总线的匹配机制。本章以一般方式描述平台驱动程序体系结构，以及如何处理平台数据。

*[第 6 章](06.html#4QFR40-dbde2ca892a6480b9727afb6a9c9e924)【设备树的概念】*讨论了向内核提供设备描述的机制。本章解释了设备寻址、资源处理、DT 中支持的每种数据类型及其内核 API。

*[第 7 章](http://i2c)、I2C 客户端驱动程序*，深入研究了 I2C 设备驱动程序架构、数据结构以及总线上的设备寻址和访问方法。

*[第八章](08.html#65D4E0-dbde2ca892a6480b9727afb6a9c9e924)，SPI 设备驱动*，描述了基于 SPI 的设备驱动架构，以及涉及的数据结构。本章讨论每个设备的访问方法和特性，以及应该避免的陷阱。还讨论了 SPI DT 绑定。

*[第 9 章](09.html#6MIEI0-dbde2ca892a6480b9727afb6a9c9e924)，Regmap API–一个寄存器映射抽象*，概述了 Regmap API，以及它如何抽象底层的 SPI 和 I2C 事务。本章描述了通用应用编程接口以及专用应用编程接口。

*[第 10 章](10.html#73TME0-dbde2ca892a6480b9727afb6a9c9e924)、IIO 框架*，介绍内核数据采集和测量框架，来处理数模转换器(DAC)和模数转换器(ADC)。本文介绍了 IIO API，讨论了触发缓冲区和连续数据捕获，并通过 sysfs 接口研究了单通道采集。

*[第十一章](11.html#7TLLK0-dbde2ca892a6480b9727afb6a9c9e924)，内核内存管理*，首先介绍了虚拟内存的概念，以此来描述整个内核的内存布局。本章介绍了内核内存管理子系统，讨论了内存分配和映射、它们的 API 和这种机制中涉及的所有设备，以及内核缓存机制。

*[第十二章](12.html#95ND80-dbde2ca892a6480b9727afb6a9c9e924)，DMA–直接内存访问*，介绍 DMA 及其新的内核 API:DMA 引擎 API。本章将讨论不同的 DMA 映射，并描述如何解决缓存一致性问题。此外，本章还基于恩智浦的 i.MX6 SoC，总结了用例中的全部概念。

*[第 13 章](13.html#9NR7U0-dbde2ca892a6480b9727afb6a9c9e924)，Linux 设备模型*，概述了 Linux 的核心，描述了对象在内核中是如何表示的，以及 Linux 是如何以通用的方式在引擎盖下设计的，从 kobject 开始到设备，通过总线、类和设备驱动程序。本章还强调了用户空间中有时未知的一面，即 sysfs 中的内核对象层次结构。

*[第 14 章](14.html#ADP4S0-dbde2ca892a6480b9727afb6a9c9e924)、引脚控制和 GPIO 子系统*描述了内核 pincontrol API 和 GPIOLIB，GPIOLIB 是处理 GPIO 的内核 API。本章还讨论了旧的和不推荐使用的基于整数的 GPIO 接口，以及新的基于描述符的接口，最后，还讨论了在 DT 中配置它们的方式。

*[第 15 章](15.html#B1Q0M0-dbde2ca892a6480b9727afb6a9c9e924)，GPIO 控制器驱动程序–GPIO _ chip*，编写此类设备驱动程序的必要元素。也就是说，它的主要数据结构是 struct gpio_chip。这一结构在本章中有详细的解释，以及在书的来源中提供的一个完整的和工作的驱动程序。

*[第 16 章](16.html#B7H420-dbde2ca892a6480b9727afb6a9c9e924)，高级 IRQ 管理*，揭开 Linux IRQ 内核的神秘面纱。本章介绍 Linux IRQ 管理，从中断在系统上的传播开始，然后到中断控制器驱动程序，从而解释了使用 Linux IRQ 域 API 的 IRQ 多路复用的概念

*[第 17 章](17.html#BIVAQ0-dbde2ca892a6480b9727afb6a9c9e924)，输入设备驱动*，提供了输入子系统的全局视图，处理基于 IRQ 和轮询的输入设备，并介绍了两种 API。本章解释并展示了用户空间代码如何处理此类设备。

*[第 18 章](18.html#BRHVS0-dbde2ca892a6480b9727afb6a9c9e924)【RTC 驱动】*走完并揭开 RTC 子系统及其 API 的神秘面纱。这一章足够深入，解释了如何处理来自 RTC 驱动程序的警报

*[第 19 章](19.html#C535G0-dbde2ca892a6480b9727afb6a9c9e924)【PWM 驱动】*提供了 PWM 框架的完整描述，谈到了控制器端 API 以及消费者端 API。本章最后一节讨论了用户空间的脉宽调制管理。

*[第 20 章](20.html#CCNA00-dbde2ca892a6480b9727afb6a9c9e924)【监管框架】*强调了电源管理的重要性。本章的第一部分涉及电源管理集成电路(PMIC)，并解释其驱动程序设计和应用编程接口。第二部分集中在消费者方面，谈的是请求和使用监管机构。

*[第 21 章](21.html#D3JNG0-dbde2ca892a6480b9727afb6a9c9e924)，Framebuffer 驱动程序*，解释了 framebuffer 的概念及其工作原理。它还展示了如何设计 framebuffer 驱动程序，介绍了它的 API，并讨论了加速和非加速方法。本章展示了驱动程序如何公开 framebuffer 内存，以便用户可以写入空间，而不用担心底层任务。

*[第 22 章](22.html#DF1U80-dbde2ca892a6480b9727afb6a9c9e924)，网卡驱动*，走完网卡驱动的架构和它们的数据结构，从而向你展示如何处理设备配置、数据传输和套接字缓冲。

# 这本书你需要什么

这本书假设了对 Linux 操作系统的中等水平的理解，C 编程的基本知识(至少指针处理)。仅此而已。如果给定章节需要额外技能，将向读者提供文档参考链接，以快速学习这些技能。

Linux 内核编译是一项相当漫长而繁重的任务。最低硬件或虚拟要求如下:

*   CPU: 4 色
*   内存:4 GB 内存
*   可用磁盘空间:5 GB(足够大)

在本书中，您将需要以下软件列表:

*   Linux 操作系统:最好是基于 Debian 的发行版，例如在书中使用的(Ubuntu 16.04)
*   至少是 gcc 和 gcc-arm-linux 的第 5 版(如书中所用)

其他必要的包在本书的专门章节中描述。下载内核源代码需要互联网连接。

# 这本书是给谁的

为了利用这本书的内容，需要有 C 编程的基本知识和 Linux 命令的基础知识。这本书涵盖了广泛使用的嵌入式设备的 Linux 驱动程序开发，使用了内核版本 v4.1，并涵盖了直到编写本书时的最后一个版本(v4.13)的变化。这本书主要面向嵌入式工程师、Linux 系统管理员、开发人员和内核黑客。无论你是软件开发人员、系统架构师，还是愿意钻研 Linux 驱动程序开发的制造商，这本书都是为你准备的。

# 约定

在这本书里，你会发现许多区分不同种类信息的文本样式。以下是这些风格的一些例子和对它们的意义的解释。文本中的码字、数据库表名、文件夹名、文件名、文件扩展名、路径名、伪 URL、用户输入和 Twitter 句柄如下所示:“在板特定文件中注册设备时，`.name`字段必须与您给出的设备名称相同”。

代码块设置如下:

```
#include <linux/of.h> 
#include <linux/of_device.h> 
```

任何命令行输入或输出都编写如下:

```
 sudo apt-get update
 sudo apt-get install linux-headers-$(uname -r)  
```

**新名词**和**重要词语**以粗体显示。

Warnings or important notes appear like this. Tips and tricks appear like this.

# 读者反馈

我们随时欢迎读者的反馈。让我们知道你对这本书的看法——你喜欢或不喜欢什么。读者反馈对我们来说很重要，因为它有助于我们开发出你真正能从中获益的标题。要给我们发送一般反馈，只需发送电子邮件`feedback@packtpub.com`，并在您的邮件主题中提及书名。如果您对某个主题有专业知识，并且对写作或投稿感兴趣，请参见我们位于[www.packtpub.com/authors](http://www.packtpub.com/authors)的作者指南。

# 客户支持

现在，您已经自豪地拥有了一本书，我们有许多东西可以帮助您从购买中获得最大收益。

# 下载示例代码

你可以从你在[http://www.packtpub.com](http://www.packtpub.com)的账户下载这本书的示例代码文件。如果您在其他地方购买了这本书，您可以访问[http://www.packtpub.com/support](http://www.packtpub.com/support)并注册将文件直接通过电子邮件发送给您。您可以按照以下步骤下载代码文件:

1.  使用您的电子邮件地址和密码登录或注册我们的网站。
2.  将鼠标指针悬停在顶部的“支持”选项卡上。
3.  点击代码下载和勘误表。
4.  在搜索框中输入图书的名称。
5.  选择要下载代码文件的书籍。
6.  从您购买这本书的下拉菜单中选择。
7.  点击代码下载。

下载文件后，请确保使用最新版本的解压缩文件夹:

*   视窗系统的 WinRAR / 7-Zip
*   zipeg/izp/un ARX for MAC
*   适用于 Linux 的 7-Zip / PeaZip

这本书的代码包也托管在 GitHub 上，网址为[https://GitHub . com/PacktPublishing/Linux-设备-驱动程序-开发](https://github.com/PacktPublishing/Linux-Device-Drivers-Development)。我们还有来自丰富的图书和视频目录的其他代码包，可在[https://github.com/PacktPublishing/](https://github.com/PacktPublishing/)获得。看看他们！

# 下载这本书的彩色图片

我们还为您提供了一个 PDF 文件，其中包含本书中使用的截图/图表的彩色图像。彩色图像将帮助您更好地理解输出中的变化。您可以从[https://www . packtpub . com/sites/default/files/downloads/LinuxDeviceDriversDevelopment _ color images . pdf](https://www.packtpub.com/sites/default/files/downloads/LinuxDeviceDriversDevelopment_ColorImages.pdf)下载此文件。

# 正误表

尽管我们尽了最大努力来确保我们内容的准确性，但错误还是会发生。如果你在我们的某本书里发现一个错误，也许是文本或代码中的错误，如果你能向我们报告，我们将不胜感激。通过这样做，你可以让其他读者免受挫折，并帮助我们改进这本书的后续版本。如果您发现任何勘误表，请访问[http://www.packtpub.com/submit-errata](http://www.packtpub.com/submit-errata)，选择您的书籍，点击勘误表提交表格链接，并输入您的勘误表的详细信息。一旦您的勘误表得到验证，您的提交将被接受，勘误表将上传到我们的网站或添加到该标题勘误表部分下的任何现有勘误表列表中。要查看之前提交的勘误表，请前往[https://www.packtpub.com/books/content/support](https://www.packtpub.com/books/content/support)并在搜索栏中输入图书名称。所需信息将出现在勘误表部分。

# 海盗行为

在互联网上盗版受版权保护的材料是一个贯穿所有媒体的持续问题。在 Packt，我们非常重视版权和许可证的保护。如果您在互联网上遇到任何形式的我们作品的非法拷贝，请立即向我们提供位置地址或网站名称，以便我们寻求补救。请通过`copyright@packtpub.com`联系我们，获取疑似盗版资料的链接。我们感谢您在保护我们的作者方面的帮助，以及我们为您带来有价值内容的能力。

# 问题

如果您对本书的任何方面有问题，可以在`questions@packtpub.com`联系我们，我们将尽最大努力解决问题。